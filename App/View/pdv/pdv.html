{% extends "base.html" %}

{% block title %}PDV{% endblock %}

{% block stylesheet %}
{% endblock %}

{% block body %}

<!-- Modal -->
<div class="modal fade" id="permissao" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog modal-sm" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">Permitir desconto</h4>
			</div>
			<div class="modal-body">
				<form id="permissaoSenha">
					<label>CPF</label>
					<input type="text" class="form-control input-sm" name="cpf" id="cpf">
					<label>Senha</label>
					<input type="password" class="form-control" name="senha" id="senha">
				</form>
			</div>
			<div class="modal-footer">
				<button id="permitirDesconto" type="button" class="btn btn-warning" data-dismiss="modal">Enviar</button>
  
			</div>
		</div>
	</div>
</div>



<div class="container" style="margin-top: -55px;">
    <h3 style="color: green;">Lançar Venda</h3>
    <br>
    <div class="row">
        <div class="col-sm-6">
            <form method="post" id="frmComanda">
                <div class="row">
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label for="numeroComanda" style="color: rgb(0, 19, 128);" >Número Comanda</label>
                            <input type="text" class="form-control input-sm" id="numeroComanda" name="numeroComanda" pattern="REINO[0-9]{4}" title="REINO####">
                            <input type="submit" id="sub">
                        </div>
                    </div>
                </div>

                <div class="row" id="grupoCpf">
                    <div class="col-sm-4">
						<div class="form-group">
							<label>Digite o CPF</label>
							<select class="form-control input-sm" id="clienteCpf" name="clienteCpf" required>
								<option value="" readonly="true">Só números</option>
								<!-- <option value="{{produto.id}}">{{cliente.cpf}}</option> -->
							</select>
						</div>
					</div>
					<div class="col-sm-4">
						<div class="form-group">
							<label>Nome </label>
							<input readonly="" type="text" class="form-control input-sm" id="nomeClienteComanda" name="nomeClienteComanda">
						</div>
					</div>
                </div>

                <div class="mb-3 form-check">
					<input type="checkbox" class="form-check-input" id="anonimo">
					<label class="form-check-label" for="anonimo">Anônimo</label>
				</div>
                <br>

                <div class="row">
                    <div class="col-sm-4">
                        <div class="form-group">
							<label>Código</label>
							<input type="textbox" class="form-control input-sm" id="codigo" name="codigo" data-nome="" data-id="">
						</div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-group">
							<label>Produto</label>
							<select class="form-control input-sm" id="produtoVenda" name="produtoVenda">
								<option value="">Selecionar</option>
								<!--<option value="{{produto.id}}">{{produto.nome}}</option>--> 
							</select>
						</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label>Descrição</label>
                            <textarea readonly="" id="descricaoV" name="descricaoV" class="form-control input-sm"></textarea>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-group">
							<label>Quantidade Estoque</label>
							<input readonly="" type="text" class="form-control input-sm" id="quantidadeV" name="quantidadeV">
						</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-4">
                        <div class="form-group">
							<label>Preço</label>
							<input readonly="" type="text" class="form-control input-sm" id="precoV" name="precoV">
						</div>
                    </div>

                    <div class="col-sm-4">
                        <div class="form-group">
							<label>Quantidade Vendida</label>
							<input type="number" class="form-control input-sm" id="quantV" name="quantV">
						</div>
                    </div>
                </div>

                <div class="row">
					<div class="col-sm-5" style="margin-left: 30px;">
						<span type="submit" class="btn btn-primary btn-block" id="btAddTemp">Adicionar</span>
					</div>
                </div>
			</form>	
        </div>

        <div class="col-sm-6">
            <div class="row">
                <table id="tabelaComanda" class="table table-bordered table-hover table-condensed" style="text-align: center; margin-top: 50px;">
                    <thead>
                        <tr class="table-primary">
                        <th scope="col">Nome</th>
                        <th scope="col">Descrição</th>
                        <th scope="col">Quantidade</th>
                        <th scope="col">Preço</th>
                        <th scope="col">Subtotal</th>
                        <!-- <th scope="col">Excluir</th> -->
                        </tr>
                    </thead>
                    <tbody>
                        
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"></td>
                            <th>Total</th>
                            <td id="valorTotal">R$ 0,00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <br>
            <div id="botoesComandaAtiva">
                <div class="row" >
                    <div class="col-sm-4">
                        <span class="btn btn-danger" id="btnLimparComanda" style="margin-right: 20px;">Limpar Comanda</span>
                    </div>

                    <div class="col-sm-4">
                        <span type="submit" class="btn btn-success" name="finalizarVenda" id="finalizarVenda" >Finalizar Venda</span>
                    </div>
                </div>    
            </div>
            <br>
            <div id="formasPagamentos">

                <div class="row">
                    <div class="col-sm-4">
                        <label>1ª Forma de pagamento</label>
                        <div>
                            <select class="form-control input-sm" id="pgUm" name="pgUm" required onchange="vezesCartao(value)">
                                <option value="" readonly="true">Selecionar</option>
                                <option value="1" >Dinheiro</option>
                                <option value="2">Pix</option>
                                <option value="3">Debito</option>
                                <option value="4">Credito</option>
                                <!-- <option value="{{produto.id}}">{{cliente.cpf}}</option> -->
                            </select>
                        </div>
                    </div>
                    <div id="vzsCartaoUm" class="col-sm-4">
                        <label>x no cartão</label>
                        <input type="number" class="form-control input-sm" name="vzsCartaoUm" id="vzsCartao">
                    </div>				
                    <div class="col-sm-4">
                        <label>Valor a pagar</label>
                        <div>
                            <input type="text" class="form-control input-sm" id="valorUm" name="valorUm">
                        </div>
                    </div>
                </div>	
    
                <div id="pagamentoDois">
                    <div class="row">
                        <div class="col-sm-4">
                            <label>2ª Forma de pagamento</label>
                            <div>
                                <select class="form-control input-sm" id="pgDois" name="pgDois" required onchange="vezesCartao(value)">
                                    <option value="" readonly="true">Selecionar</option>
                                    <option value="1" >Dinheiro</option>
                                    <option value="2">Pix</option>
                                    <option value="3">Debito</option>
                                    <!-- <option value="4">Credito</option> -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-sm-4">
                            <label>Valor a pagar</label>
                            <div>
                                <input type="text" class="form-control input-sm" id="valorDois" name="valorDois">
                            </div>
                        </div>
                    </div>
                </div>
    
                <br>	
                <div class="row" id="trocoUm">
                    <div class="col-sm-4">
                        <label>Troco</label>
                        <input type="text" class="form-control input-sm" name="trocoUmDinheiro" id="trocoUmDinheiro">
                    </div>
                </div>	
                <br>

                <div id="botoesComandaAPagar">
                    <div class="row" >
                        <div class="col-sm-4">
                            <span class="btn btn-primary" id="voltarFormulario" >Voltar</span>
                        </div>
    
                        <div class="col-sm-4">
                            <span type="submit" class="btn btn-success" name="gravarVenda" id="gravarVenda" >GRAVAR</span>
                        </div>
                    </div>    
                </div>

            </div>            
               
        </div>

    </div>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
	/**
     * Todos os campos do formulario inativos ate escolher uma opcao no RadioOptions
     */
	$(document).ready(function(){
		$("#clienteCpf").prop("disabled", true);
		$("#nomeClienteComanda").prop("disabled", true);
		$("#codigo").prop("disabled", true);
		$("#descricaoV").prop("disabled", true);
		$("#produtoVenda").prop("disabled", true);
		$("#quantidadeV").prop("disabled", true);
		$("#precoV").prop("disabled", true);
		$("#quantV").prop("disabled", true);
		$("#anonimo").prop("disabled", true);
		$("#vzsCartaoUm").hide();
		$("#vzsCartaoDois").hide();
		$("#pagamentoDois").hide();
		$("#pgDois").hide();
		$("#trocoUm").hide();
		$("#formasPagamentos").hide();
		$("#valorUm").prop("disabled", true);
		$("#pgUm").prop("disabled", true);
		$("#sub").hide();
        $("#btAddTemp").hide();
		$("#botoesComandaAtiva").hide();
	});

	function habilitarCampos(){
		$("#clienteCpf").prop("disabled", false);
		$("#nomeClienteComanda").prop("disabled", false);
		$("#codigo").prop("disabled", false);
		$("#produtoVenda").prop("disabled", false);
		$("#quantidadeV").prop("disabled", false);
		$("#precoV").prop("disabled", false);
		$("#quantV").prop("disabled", false);
		$("#descricaoV").prop("disabled", false);
		$("#anonimo").prop("disabled", false);
		$("#quantV").val(1);
		$("#valorUm").prop("disabled", false);
		$("#pgUm").prop("disabled", false);
		$('#pgUm').val(1).trigger('change');
        $("#botoesComandaAtiva").show();
		$("#valorUm").maskMoney({prefix:'R$ ', allowNegative: false, thousands:'.', decimal:','});
		$("#valorDois").maskMoney({prefix:'R$ ', allowNegative: false, thousands:'.', decimal:','});
		$("#trocoUmDinheiro").maskMoney({prefix:'R$ ', allowNegative: false, thousands:'.', decimal:','});
        $("#btAddTemp").show();
	};

	function vezesCartao(){
		if($('#pgUm').val() == 4){
			$("#vzsCartao").prop("disabled", false);
			$("#vzsCartaoUm").show();
		}else{
			$("#vzsCartaoUm").hide();
		}
		if($('#pgDois').val() == 4){
			$("#vzsCartaoDois").show();
		}else{
			$("#vzsCartaoDois").hide();
		}
	};

	/**
	* JSON para enviar a comanda
	*/
	var comanda = {
		cliente: null,
		numero: null,
		linhas:[]
	};
</script>

<script type="text/javascript">
var valorUm = $('#valorUm').maskMoney('unmasked')[0];
    $('#finalizarVenda').click(function () {
        console.log(valorUm);
        if($('#valorUm').maskMoney('unmasked')[0]){
            $("#clienteCpf").prop("disabled", true);
            $("#nomeClienteComanda").prop("disabled", true);
            $("#codigo").prop("disabled", true);
            $("#descricaoV").prop("disabled", true);
            $("#produtoVenda").prop("disabled", true);
            $("#quantidadeV").prop("disabled", true);
            $("#precoV").prop("disabled", true);
            $("#quantV").prop("disabled", true);
            $("#anonimo").prop("disabled", true);
            $("#formasPagamentos").show();
            $("#botoesComandaAtiva").hide();
            $("#frmComanda").hide();
        }else{
            alertify.error("Não possui produtos!");
        }  
    });

    function voltarFormulario() {
        $("#formasPagamentos").hide();
        $("#frmComanda").show();
    }

    $('#voltarFormulario').click(function () {
        $("#botoesComandaAtiva").show();
        $("#formasPagamentos").hide();
        $("#frmComanda").show();
        habilitarCampos();
    });
</script>

<script type="text/javascript">
	$('#anonimo').click(function(){
		if($('#anonimo')[0].checked == true){
			$("#grupoCpf").hide();
		}
		if($('#anonimo')[0].checked == false){
			$("#grupoCpf").show();
			$("#clienteCpf").prop("disabled", false);
			$("#nomeClienteComanda").prop("disabled", false);
		}
	});
</script>

<script type="text/javascript">
    /**
    * Tras informaçoes para o select
    */
    $("#clienteCpf").select2({
        language: "pt-BR",
        minimumInputLength: 14,
        ajax: {
            url: 'pesquisar-cliente',
            dataType: 'json',
            success:function(r){
                $('#nomeClienteComanda').val(r.results[0]['nome'] + " " + r.results[0]['sobrenome']);
                comanda.cliente = r.results[0]['id'];
                // if('#clienteCpf'){
                // 	$("#clienteCpf").prop("disabled", true);
                // 	//$("#nomeClienteComanda").prop("disabled", true);
                // }
            }
        }
    })
    //Coloca mascara no select2
    .on("select2:open", function () {
        $(".select2-search__field")
        .attr("type","text")
        .mask("000.000.000-00");  
    });
    
    /**
     * select de produto .. tras o id e o nome
     */
    $("#produtoVenda").select2({
        language: "pt-BR",
        minimumInputLength: 3,
        ajax: {
            url: 'pesquisar-produto',
            dataType: 'json'
        }
    });

    $("#pgUm").select2();
    $("#pgDois").select2();
</script>

<script type="text/javascript">
	/**
	* Entter inserir codigo da comanda
	*/
	$('#numeroComanda').on('keypress',function(e) {
		if(e.which == 13 && e.target.validity.valid) {
			e.preventDefault();
			$.ajax({
				type: "POST",
				data: "numero=" + $('#numeroComanda').val(),
				url: "obter-dados-numero",
				success:function(r){
					if(r != 'false' && r != 'fechadafalse'){
						var resp = JSON.parse(r);
                        comanda = resp;
                        itensSoma($('#tabelaComanda'));
		                atualizarTabela($('#tabelaComanda'));
						clienteComanda(comanda.id_cliente);
						habilitarCampos();
						$('#valorUm').focus();
                        console.log(comanda);
                    }
					if(r == 'fechadafalse'){
						var numeroComanda = $('#numeroComanda').val();
						apagarForm();
						$('#numeroComanda').val(numeroComanda);
						alertify.error('Comanda fechada.');
					}
					if(r == 'false'){
						var numeroComanda = $('#numeroComanda').val();
						apagarForm();
						$('#numeroComanda').val(numeroComanda);
						habilitarCampos();
						alertify.success('Abertura de comanda.');
					}
				}
			});
		}
	});


	/**
	* Entter para pesquisar
	*/
	$('#codigo').on('keypress',function(e) {
		if(e.which == 13) {
			$.ajax({
				type:"POST",
				data:"codigo=" + $('#codigo').val(),
				url:"pesquisar-prod-est-codigo",
				success:function(r){
					console.log('resposta',r);
					var resp = JSON.parse(r);
					if(resp.length > 0){
						$('#codigo').attr('data-id', parseInt(resp[0]['id']));
						$('#codigo').attr('data-nome', resp[0]['nome']);
						$('#descricaoV').val(resp[0]['descricao']);
						$('#quantidadeV').val(resp[0]['quantotal']);
						$('#precoV').val(resp[0]['preco_ven']);
						$('#btAddTemp').click(); 
						$('#valorUm').focus();
					}else{
						alertify.error('Produto nao encontrado.');
					}
				}
			});
		}
	});
</script>

<script type="text/javascript">
	/**
	 * Coloca os itens na tabela temporaria
	 */
	function atualizarTabela(tabela) {
		var tbody = tabela.find('tbody');
		tbody.empty();
		i=0;
		comanda.linhas.forEach(linha => {
			tbody.append(`<tr id="${i++}"> <th>${linha.nomeProduto}</th> <td>${linha.descricaoV}</td>  <td>${linha.quantV}</td> <td>${parseFloat(linha.precoV).toLocaleString('pt-br',{style: 'currency', currency: 'BRL'})}</td><td> ${(linha.quantV*linha.precoV).toLocaleString('pt-br',{style: 'currency', currency: 'BRL'})}</td><td class="btn-danger glyphicon glyphicon-remove" id="remove" onclick="apagarItem(${i}, ${linha.produtoVenda})"></td></tr>`);
		});
	};

	/**
	 * Faz a soma do subtotal
	 */
	function itensSoma(tabela) {
		var total = tabela.find('#valorTotal');
		total.html('R$ 0,00');
		var soma = 0.0;
		comanda.linhas.forEach(linha => {
			soma += linha.quantV*linha.precoV;
		});
		total.html(soma.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}));
		valorPagar(soma);
	}

	/**
	 * Apaga tds os dados do formulario
	 */
	function apagarForm() {
		comanda={
			cliente: null,
			numero: null,
			linhas:[]
		};
		itensSoma($('#tabelaComanda'));
		atualizarTabela($('#tabelaComanda'));
		$('#frmComanda')[0].reset();
		$('#produtoVenda').val(null).trigger('change');//reseta o select2
		$('#clienteCpf').val(null).trigger('change');
		$('#quantV').val(1);
		$('#codigo').attr('data-id', "");
		$('#codigo').attr('data-nome', "");
		$('#grupoCpf').show();
		$('#pgUm').val(null).trigger('change');
		$('#pgDois').val(null).trigger('change');
		$('#pagamentoDois').hide();
		$('#valorDois').val("");
	}

	/**
	 * Apaga item da tabela temp
	 */
	function apagarItem(i, idproduto){
		var dados = {
			id_comanda_fatura: parseInt(comanda.id)
		};
		var tbody = $('#tabelaComanda').find('tr')[i];
		if(dados.id_comanda_fatura){
			$.ajax({
				type:"DELETE",
				data: dados,
				url:"apaga-prod-comanda",
				success:function(r){
					if(r == true){
						// console.log('r',r);
						tbody.remove();
						delete comanda.linhas[i-1];
						itensSoma($('#tabelaComanda'));
						atualizarTabela($('#tabelaComanda'));
					}else{
						alertify.error("Não foi possível excluir");	
					}
				}
			});
		}else{
			tbody.remove();
			delete comanda.linhas[i-1];
			itensSoma($('#tabelaComanda'));
			atualizarTabela($('#tabelaComanda'));
		}
	}

	/**
	 * Comanda aberta com cliente, tras para a tela
	 */
	function clienteComanda(idCliente) {
		$.ajax({
			type:"POST",
			data:"cliente=" + idCliente,
			url:"pesq-cliente-comanda",
			success:function(r){
				var resp = JSON.parse(r);
				if(resp != ""){
					$('#nomeClienteComanda').val(resp[0]['nome'] + " " + resp[0]['sobrenome']);
					comanda.cliente = resp[0]['id'];
				}
			}
		});
	}
</script>

<script type="text/javascript">
	/**
	* Cria a comanda ENVIAR PARA O BANCO
	*/
	$('#gravarVenda').click(function() {
		valorRestante();
	});	
		
		
	function gravarComanda() {
		var vtDois = $('#valorDois').maskMoney('unmasked')[0];
		if($('#anonimo')[0].checked || $('#nomeClienteComanda').val() != ""){
			if($('#pgUm').val() != ""){
				if((vtDois > 0  && $('#pgDois').val()) || vtDois == 0 ){
					var dados={
						cliente: (comanda.cliente!=null?parseInt(comanda.cliente):null),
						numero: (comanda.numero!=null?(comanda.numero):null),
						pg_forma1: $('#pgUm').val(),
						valor_total1: $('#valorUm').maskMoney('unmasked')[0],
						pg_forma2: $('#pgDois').val(),
						valor_total2: $('#valorDois').maskMoney('unmasked')[0],
						vzs_cartao: $('#vzsCartao').val(),
						linhas:[]
					};
					comanda.linhas.forEach(linha =>{
						var novaLinha = {
							id_produto: parseInt(linha.produtoVenda),
							quantidade: parseInt(linha.quantV),
							quant_estoque: linha.quantidadeV,
							valor_unitario: parseFloat(linha.precoV)
						};
						dados.linhas.push(novaLinha);
						// console.log('dados.Gravar',dados.linhas);
						apagarForm();
					});
					console.log('dados', dados);

					$.ajax({
						type:"POST",
						data: dados,
						url:"gravar-venda",
						success:function(r){
							console.log('respostaGravou1',r);
							var resp = JSON.parse(r);
							// console.log('respostaGravou2',resp);
							if(resp.resp == true){	
								// console.log('resp',resp.resp);
								$('#codigo').val('');
								$('#clienteCpf').val(null).trigger('change');
								$('#nomeClienteComanda').val('');
								apagarForm();
								alertify.success("Venda efetuada!!");
							}else{
								alertify.error("Falha ao Adicionar");
							}
						}
					});
				}else{alertify.alert("Preencher forma de pagamento! pgdois");}
			}else{alertify.alert("Preencher forma de pagamento! pgum");}

		}else{alertify.alert("Preencher o CPF!");} 
	};	
</script>

<script type="text/javascript">
	

		// $('#clienteCpf').change(function(){
		// 	$.ajax({
		// 		type:"POST",
		// 		data:"idcliente=" + $('#clienteCpf').val(),
		// 		url:"obter-dados-cli",
		// 		success:function(r){
		// 			dado=jQuery.parseJSON(r);
		// 			$('#nomeClienteComanda').val(dado['nome'] + " " + dado['sobrenome']);
		// 		}
		// 	});
		// });


    /**
     * Completa os campos do produto de acordo com o id do select
     */
    $('#produtoVenda').change(function(){
        $.ajax({
            type:"POST",
            data:"id=" + $('#produtoVenda').val(),
            url:"pesquisar-prod-est",
            success:function(r){
                var resp = JSON.parse(r);
                if(resp.length > 0){
                    $('#descricaoV').val(resp[0]['descricao']);
                    $('#quantidadeV').val(resp[0]['quantotal']);
                    $('#precoV').val(resp[0]['preco_ven']);	
                }
            }
        });
    });

		$('#quantV').click(function(){

			var quant = parseInt($('#quantV').val());
			var quantidade = parseInt($('#quantidadeV').val()); 
			
			if(quant > quantidade){
				alertify.alert("Quantidade inexistente em estoque!!");
				quant = $('#quantV').val("");
				return false;
			}else{
				quantidade = $('#quantidadeV').val();
			}
		});


    /**
    * Adiciona os itens na tabela temporaria 
    */
    $('#btAddTemp').click(function(){
        
        var quant = parseInt($('#quantV').val());
        var quantidade = parseInt($('#quantidadeV').val());

        
        if(quant > quantidade){
            alertify.alert("Quantidade inexistente em estoque!!");
            quant = $('#quantV').val("");
            return false;
        }else{
            quantidade = $('#quantidadeV').val();
        }
        
        if($('#quantV').val() == "" || $('#quantV').val() <= 0){
            alertify.alert("Preencha a quantidade desejada!!");
            return false;
        }

        /**
        * Pega as informaçoes do formulario e transforma em json para adicionar no array
        */
        var jsonData = {};
        var formData = $("#frmComanda").serializeArray();

        $.each(formData, function() {
            if (jsonData[this.name]) {
            if (!jsonData[this.name].push) {
                    jsonData[this.name] = [jsonData[this.name]];
            }
                jsonData[this.name].push(this.value || '');
            } else {
                jsonData[this.name] = this.value || '';
            }
        });
        if($('#codigo').val() == ""){
            jsonData['nomeProduto'] = $('#produtoVenda option:selected').text();
        }else{
            jsonData['produtoVenda'] = $('#codigo').attr('data-id');
            jsonData['nomeProduto'] = $('#codigo').attr('data-nome');
        }
        
        /**
        * Coloca os itens temporarios na tabela
        */
        comanda.linhas.push(jsonData);
        
        itensSoma($('#tabelaComanda'));
        atualizarTabela($('#tabelaComanda'));
        
        $('#produtoVenda').val(null).trigger('change');//reseta o select2
        $('#quantV').val(1);
        $('#precoV').val('');
        $('#descricaoV').val('');
        $('#quantidadeV').val('');
        $('#codigo').val('');
        $('#codigo').attr('data-id', "");
        $('#codigo').attr('data-nome', "");
    });


    /**
    *Botao limpar formulario
    */
    $('#btnLimparComanda').click(function(){
        apagarForm();
    });
</script>

<script type="text/javascript">
    /**
     * Ao perder o foco, testa o padrão do campo
    */
    $('#numeroComanda').focusout(function(e) {
        if(!e.target.validity.valid){
            $('#frmComanda')[0].reportValidity();
        }
    });
    
    $('#numeroComanda').keyup(function(e) {
        if(e.which == 13){
            e.preventDefault();
        }
    });
</script>

<script type="text/javascript">
	// $('#pgUm').click(function(){
	// 	console.log('ak2');
	// 	if($('#pgUm').val == 1){
	// 		console.log('ak2');
	// 	}
	// });

	function valorPagar(soma){
		$('#valorUm').val(soma.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}));
		$('#valorUm').change(function(){
			var valorUm = $('#valorUm').maskMoney('unmasked')[0];
			if(valorUm > soma){
				$("#trocoUm").show();
				var troco = valorUm - soma;
				$("#trocoUmDinheiro").val(troco.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}));
				$("#pagamentoDois").hide();
				$("#valorDois").val('');
			}else if(valorUm < soma){
				var valorDois = soma - valorUm;
				$("#trocoUm").hide();
				$("#trocoUmDinheiro").val('');
				$("#pagamentoDois").show();
				$('#valorDois').val(valorDois.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}));
			} else {
				$("#pagamentoDois").hide();
				$("#valorDois").val('');
				$("#trocoUm").hide();
				$("#trocoUmDinheiro").val('');
			}
		});

		$('#valorDois').change(function(){
			valorDois = $('#valorDois').maskMoney('unmasked')[0];
			valorUm = $('#valorUm').maskMoney('unmasked')[0];
			var valorVenda = valorUm + valorDois;
			if(soma < valorVenda){
				troco = valorVenda - soma;
				$("#trocoUm").show();
				$("#trocoUmDinheiro").val(troco.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}));
			}else if(valorVenda == soma){
				$("#trocoUm").hide();
				$("#trocoUmDinheiro").val('');
			}else if(valorDois == 0){
				$("#trocoUm").hide();
				$("#trocoUmDinheiro").val('');
				$("#pagamentoDois").hide();
				// $('#pgDois').val(null).trigger('change');
			}
		});
	};

	function valorRestante() {
		var totalLinha = 0.0;
		comanda.linhas.forEach(linha => {
			totalLinha += linha.quantV*linha.precoV;
		});
		valorUm = $('#valorUm').maskMoney('unmasked')[0];
		valorDois = $('#valorDois').maskMoney('unmasked')[0];
		var somaCampos = valorUm + valorDois;
		var dezPorcento = totalLinha - (totalLinha * 0.1);
		if(dezPorcento > somaCampos){
			alertify.confirm('Desconto maior que o permitido! ', function(){
				$("#permissao").modal({
					show: true
				});
			}, function(){ 
				alertify.error('Cancelado !');
			});
			return false;
		}else{
			gravarComanda();
			voltarFormulario();
		}
	}
</script>

<script type="text/javascript">
	$('#permitirDesconto').click(function(e) {
		e.preventDefault();
		vazios=validarFormVazio('permissaoSenha');
		if(vazios > 0){
			alert("Preencha os campos!!");
			return false;
		}
		dados=$('#permissaoSenha').serialize();
		$.ajax({
			type:"POST",
			data:dados,
			url:"permissao-desconto",
			success:function(r){
				console.log(r);
				if(true){
					$('#permissaoSenha')[0].reset();
					// gravarComanda();
					alertify.confirm('Imprimir comprovante de compra? ', function(){
						href="comprovante-venda";
						let imprimir = document.getElementsByTagName('mat-dialog-content')[0];
						var mywindow = window.open('', 'PRINT', 'height=400,width=600');

						mywindow.document.write('<html><head><title>Impressão</title>');
						mywindow.document.write("<style> @font-face { font-family: 'Montserrat'; font-style: normal; font-weight: 200; font-display: swap; src: url(https://fonts.gstatic.com/s/montserrat/v24/JTUSjIg1_i6t8kCHKm459Wlhyw.woff2) format('woff2'); unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD; } @font-face { font-family: 'Roboto Mono'; font-style: normal; font-weight: 600; font-display: swap; src: url(https://fonts.gstatic.com/s/robotomono/v21/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_AP2_ROW4.woff2) format('woff2'); unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD; } body{ font-family: 'Roboto Mono', 'Montserrat', sans-serif !important; max-width: 264.567px; font-size: 10px; } h2{ font-size: 13px; } table{ font-size: 8px; } small{ font-size: 6px; word-break: break-all; } .item-left{ text-align: left; } .letra{ height: 60px; } hr{ border-top: 1px dashed black; } p{ margin: 0 0 0px; } table { border-collapse: collapse; } .flex {display: flex !important;} .justify-content-between { justify-content: space-between !important; } .t-center {text-align: center !important;} .t-right {text-align: right !important;} h2 { font-family: 'Roboto Mono', Roboto, 'Helvetica Neue', sans-serif; letter-spacing: normal; margin: 0 0 16px} </style>");
						mywindow.document.write('</head><body >');
						mywindow.document.write(imprimir.innerHTML);
						mywindow.document.write('</body></html>');

						mywindow.print();
						console.log('imprimir');
					}, function(){ 
						alertify.error('Cancelado !');
					});
				}else{
					alert(r);
					alertify.error("Acesso Negado!!");
				}
			}
		});
	});

</script>

{% endblock %}