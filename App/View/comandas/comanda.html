{% extends "base.html" %}

{% block title %}Comandas{% endblock %}

{% block stylesheet %}
{% endblock %}

{% block body %}

<div class="container">
    <h3>Abrir Comanda</h3>
 
	<div class="row">
		<div class="col-sm-3">
			<div class="form-check form-check-inline ">
			  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="cpf" value="cpf">
			  <label class="form-check-label" for="inlineRadio1">CPF</label>
			</div>
		</div>
		<div class="col-sm-3">
			<div class="form-check form-check-inline ">
			  <input class="form-check-input" type="radio" name="inlineRadioOptions" id="numero" value="numero">
			  <label class="form-check-label" for="inlineRadio2">Número</label>
			</div>
		</div>
	</div>

    <br/>

    <section class="direita">
		<div class="row">
			<form method="post" id="frmComanda">
				<div class="row" id="grupoNumero">
					<div class="col-sm-6">
						<div class="form-group">
							<label>Numero Comanda</label>
							<input readonly="" type="text" class="form-control input-sm" id="numeroComanda" name="numeroComanda">
						</div>
					</div>
				</div>
				<div class="row" id="grupoCpf">
					<div class="col-sm-6">
						<div class="form-group">
							<label>Selecionar Cliente</label>
							<select class="form-control input-sm" id="clienteCpf" name="clienteCpf" required>
								<option value="" readonly="true">Selecionar</option>
								<!-- <option value="{{produto.id}}">{{cliente.cpf}}</option> -->
							</select>
						</div>
					</div>
					<div class="col-sm-6">
						<div class="form-group">
							<label>Nome </label>
							<input readonly="" type="text" class="form-control input-sm" id="nomeClienteComanda" name="nomeClienteComanda">
						</div>
					</div>
				</div>
					
				<div class="row">
					<div class="col-sm-6">
						<div class="form-group">
							<label>Código</label>
							<input type="textbox" class="form-control input-sm" id="codigo" name="codigo" data-nome="">
						</div>
						<div class="form-group">
							<label>Produto</label>
							<select class="form-control input-sm" id="produtoVenda" name="produtoVenda">
								<option value="">Selecionar</option>
								<!--<option value="{{produto.id}}">{{produto.nome}}</option>--> 
							</select>
						</div>
						<div class="form-group">
							<label>Descrição</label>
							<textarea readonly="" id="descricaoV" name="descricaoV" class="form-control input-sm"></textarea>
						</div>
						<div class="form-group">
							<label>Quantidade Estoque</label>
							<input readonly="" type="text" class="form-control input-sm" id="quantidadeV" name="quantidadeV">
						</div>
						<div class="form-group">
							<label>Preço</label>
							<input readonly="" type="text" class="form-control input-sm" id="precoV" name="precoV">
						</div>	
						<div class="form-group">
							<label>Quantidade Vendida</label>
							<input type="number" class="form-control input-sm" id="quantV" name="quantV">
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-sm-3">
						<span type="submit" class="btn btn-primary btn-block" id="btAddTemp">Adicionar</span>
					</div>
					<div class="col-sm-3">
						<span class="btn btn-danger" id="btnLimparComanda">Limpar Comanda</span>
					</div>
				</div>
			</form>	
		</div>
	</section>
    

	<section class="esquerda">
		<div class="row">
			<table id="tabelaComanda" class="table table-bordered table-hover table-condensed" style="text-align: center;">
				<thead>
					<tr>
					  <th scope="col">Nome</th>
					  <th scope="col">Descrição</th>
					  <th scope="col">Quantidade</th>
					  <th scope="col">Preço</th>
					  <th scope="col">Subtotal</th>
					</tr>
				</thead>
				<tbody>
					
				</tbody>
				<tfoot>
					<tr>
						<td colspan="3"></td>
						<th>Total</th>
						<td id="valorTotal">R$ 0,00</td>
					</tr>
				</tfoot>
			</table>
		</div>
		<div class="row">
			<div class="col-sm-3">
				<span class="btn btn-success" id="gravarComanda">Enviar</span>
			</div>
		</div>
	</section>
	
</div>

{% endblock %}

{% block javascript %}

<script type="text/javascript">
	/**
     * Todos os campos do formulario inativos ate escolher uma opcao no RadioOptions
     */
	$(document).ready(function(){
		$("#numeroComanda").prop("disabled", true);
		$("#clienteCpf").prop("disabled", true);
		$("#nomeClienteComanda").prop("disabled", true);
		$("#codigo").prop("disabled", true);
		$("#produtoVenda").prop("disabled", true);
		$("#quantidadeV").prop("disabled", true);
		$("#precoV").prop("disabled", true);
		$("#quantV").prop("disabled", true);
	});

	$("#cpf").on("click", function () {
		$("#numeroComanda").prop("disabled", true);
		$("#clienteCpf").prop("disabled", false);
		$("#nomeClienteComanda").prop("disabled", false);
		$("#codigo").prop("disabled", false);
		$("#produtoVenda").prop("disabled", false);
		$("#quantidadeV").prop("disabled", false);
		$("#precoV").prop("disabled", false);
		$("#quantV").prop("disabled", false);
		$("#quantV").val(1);
		$("#grupoNumero").hide();
		$("#grupoCpf").show();
		$("#numero").prop("disabled", true);
	});

	$("#numero").on("click", function () {
		$("#clienteCpf").prop("disabled", true);
		$("#nomeClienteComanda").prop("disabled", true);
		$("#numeroComanda").prop("disabled", false);
		$("#codigo").prop("disabled", false);
		$("#produtoVenda").prop("disabled", false);
		$("#quantidadeV").prop("disabled", false);
		$("#precoV").prop("disabled", false);
		$("#quantV").prop("disabled", false);
		$("#quantV").val(1);
		$("#grupoCpf").hide();
		$("#grupoNumero").show();
		$("#cpf").prop("disabled", true);
	});

	/**
	* JSON para enviar a comanda
	*/
	var comanda = {
		cliente: null,
		numero: null,
		linhas:[]
	};


</script>


<script type="text/javascript">
	/**
     * Tras informaçoes para o select
     */
	$(document).ready(function(){
		$("#clienteCpf").select2({
			language: "pt-BR",
			minimumInputLength: 14,
    		ajax: {
                url: 'pesquisar-cliente',
                dataType: 'json',
                success:function(r){
					$('#nomeClienteComanda').val(r.results[0]['nome'] + " " + r.results[0]['sobrenome']);
					comanda.cliente = r.results[0]['id'];
					// if('#clienteCpf'){
					// 	$("#clienteCpf").prop("disabled", true);
					// 	//$("#nomeClienteComanda").prop("disabled", true);
					// }
				}
            }
        })
		//Coloca mascara no select2
		.on("select2:open", function () {
			$(".select2-search__field")
			.attr("type","text")
			.mask("000.000.000-00");  
		});
		
		/**
		 * select de produto .. tras o id e o nome
		 */
        $("#produtoVenda").select2({
			language: "pt-BR",
            minimumInputLength: 3,
            ajax: {
                url: 'pesquisar-produto',
                dataType: 'json'
            }
        });
	});
</script>

<script type="text/javascript">
	/**
	* Entter para pesquisar
	*/
	$('#codigo').on('keypress',function(e) {
		if(e.which == 13) {
			$.ajax({
				type:"POST",
				data:"codigo=" + $('#codigo').val(),
				url:"pesquisar-prod-est-codigo",
				success:function(r){
					// console.log('resposta',r);
					var resp = JSON.parse(r);
					if(resp.length > 0){
						$('#codigo').attr('data-nome', resp[0]['nome']);
						$('#descricaoV').val(resp[0]['descricao']);
						$('#quantidadeV').val(resp[0]['quantotal']);
						$('#precoV').val(resp[0]['preco_ven']);

						$('#btAddTemp').click(); 
					}
				}
			});
		}
	});
</script>

<script type="text/javascript">
	/**
	 * Coloca os itens na tabela temporaria
	 */
	function atualizarTabela(tabela) {
		var tbody = tabela.find('tbody');
		tbody.empty();
		comanda.linhas.forEach(linha => {
			tbody.append(`<tr> <th>${linha.nomeProduto}</th> <td>${linha.descricaoV}</td>  <td>${linha.quantV}</td> <td>${parseFloat(linha.precoV).toLocaleString('pt-br',{style: 'currency', currency: 'BRL'})}</td><td> ${(linha.quantV*linha.precoV).toLocaleString('pt-br',{style: 'currency', currency: 'BRL'})}</td></tr>`);
		});
	};

	/**
	 * Faz a soma do subtotal
	 */
	function itensSoma(tabela) {
		var total = tabela.find('#valorTotal');
		total.html('R$ 0,00');
		var soma = 0.0;
		comanda.linhas.forEach(linha => {
			soma += linha.quantV*linha.precoV;
		});
		total.html(soma.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}));
	}

	/**
	 * Faz a soma do subtotal
	 */
	 function apagarForm() {
		comanda={
			cliente: null,
			numero: null,
			linhas:[]
		};
		$('#tabelaComanda').find('tbody').empty();
		$('#tabelaComanda').find('#valorTotal').html('R$ 0,00');
		$('#frmComanda')[0].reset();
		$('#produtoVenda').val(null).trigger('change');//reseta o select2
		$('#clienteCpf').val(null).trigger('change');
		$('#quantV').val(1);
		// $('#precoV').val('');
		// $('#descricaoV').val('');
		// $('#quantidadeV').val('');
		// $('#codigo').val('');
		$('#codigo').attr('data-nome', "");
		$("#numero").prop("disabled", false);
		$("#cpf").prop("disabled", false);
	}
</script>

<script type="text/javascript">
	/**
	* Cria a comanda ENVIAR PARA O BANCO
	*/
	$('#gravarComanda').click(function() {
		
		var dados={
			cliente: (comanda.cliente!=null?parseInt(comanda.cliente):null),
			numero: (comanda.numero!=null?(comanda.numero):null),
			linhas:[]
		};
		comanda.linhas.forEach(linha =>{
			var novaLinha = {
				id_produto: parseInt(linha.produtoVenda),
				quantidade: parseInt(linha.quantV),
				valor_unitario: parseFloat(linha.precoV)
			};
			dados.linhas.push(novaLinha);
			console.log(dados.linhas);
			apagarForm();
		});
		// console.log(dados);
		$.ajax({
			type:"POST",
			data: dados,
			url:"resp-comanda",
			success:function(r){
				// console.log('respostaGravou',r);
				var resp = JSON.parse(r);
				if(resp.resp){	
					// console.log('resp',resp.resp);
					$('#codigo').val('');
					$('#clienteCpf').val(null).trigger('change');
					$('#nomeClienteComanda').val('');
					apagarForm();
					
					alertify.success("Comanda criada com sucesso!!");
				}else{
					alertify.error("Falha ao Adicionar");
				}
				
			}
		});
	});
	
</script>


<script type="text/javascript">
	$(document).ready(function(){

		// $('#clienteCpf').change(function(){
		// 	$.ajax({
		// 		type:"POST",
		// 		data:"idcliente=" + $('#clienteCpf').val(),
		// 		url:"obter-dados-cli",
		// 		success:function(r){
		// 			dado=jQuery.parseJSON(r);
		// 			$('#nomeClienteComanda').val(dado['nome'] + " " + dado['sobrenome']);
		// 		}
		// 	});
		// });


		/**
		 * Completa os campos do produto de acordo com o id do select
		 */
		$('#produtoVenda').change(function(){
			$.ajax({
				type:"POST",
				data:"id=" + $('#produtoVenda').val(),
				url:"pesquisar-prod-est",
				success:function(r){
					var resp = JSON.parse(r);
					// console.log(resp);
					if(resp.length > 0){
						$('#descricaoV').val(resp[0]['descricao']);
						$('#quantidadeV').val(resp[0]['quantotal']);
						$('#precoV').val(resp[0]['preco_ven']);	
					}
				}
			});
		});

		$('#quantV').click(function(){

			var quant = parseInt($('#quantV').val());
			var quantidade = parseInt($('#quantidadeV').val()); 
			
			if(quant > quantidade){
				alertify.alert("Quantidade inexistente em estoque!!");
				quant = $('#quantV').val("");
				return false;
			}else{
				quantidade = $('#quantidadeV').val();
			}
		});



		/**
		* Adiciona os itens na tabela temporaria 
		*/
		$('#btAddTemp').click(function(){
			
			//Cpf selecionado para abrir comanda.. ve se o campo esta preenchido
			var radio = $('input[name="inlineRadioOptions"]:checked').val();
			if((radio == 'cpf' && $('#clienteCpf')[0].checkValidity()) || radio == 'numero' ){
				

				var quant = parseInt($('#quantV').val());
				var quantidade = parseInt($('#quantidadeV').val());

				
				if(quant > quantidade){
					alertify.alert("Quantidade inexistente em estoque!!");
					quant = $('#quantV').val("");
					return false;
				}else{
					quantidade = $('#quantidadeV').val();
				}

				
				
				if($('#quantV').val() == "" || $('#quantV').val() <= 0){
					alertify.alert("Preencha a quantidade desejada!!");
					return false;
				}

				/**
				* Pega as informaçoes do formulario e transforma em json para adicionar no array
				*/
				var jsonData = {};
				var formData = $("#frmComanda").serializeArray();

				$.each(formData, function() {
					if (jsonData[this.name]) {
					if (!jsonData[this.name].push) {
							jsonData[this.name] = [jsonData[this.name]];
					}
						jsonData[this.name].push(this.value || '');
					} else {
						jsonData[this.name] = this.value || '';
					}
				});
				if($('#codigo').val() == ""){
					jsonData['nomeProduto'] = $('#produtoVenda option:selected').text();
				}else{
					jsonData['nomeProduto'] = $('#codigo').attr('data-nome');
				}
				
				
				/**
				* Coloca os itens temporarios na tabela
				*/
				comanda.linhas.push(jsonData);
				
				itensSoma($('#tabelaComanda'));
				atualizarTabela($('#tabelaComanda'));
				
				$('#produtoVenda').val(null).trigger('change');//reseta o select2
				$('#quantV').val(1);
				$('#precoV').val('');
				$('#descricaoV').val('');
				$('#quantidadeV').val('');
				$('#codigo').val('');
				$('#codigo').attr('data-nome', "");
			}else{alertify.alert("Preencher o CPF!!");} 
		});


		/**
		*Botao limpar formulario
		*/
		$('#btnLimparComanda').click(function(){
			apagarForm();
		});

	});
</script>

<!-- <script type="text/javascript">
	// Example starter JavaScript for disabling form submissions if there are invalid fields
(function() {
  'use strict';
  window.addEventListener('load', function() {
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.getElementsByClassName('needs-validation');
    // Loop over them and prevent submission
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script> -->




{% endblock %}